"use strict";

exports.__esModule = true;
exports.makeEmitPluginDocumentService = void 0;

var _graphql = require("gatsby/graphql");

const makeEmitPluginDocumentService = ({
  configMap,
  reporter,
  writeFileContent
}) => {
  return async definitions => {
    const entries = Object.entries(configMap);

    if (entries.length === 0) {
      return;
    }

    definitions = definitions.filter(def => def.printedAst);

    if (definitions.length === 0) {
      return;
    }

    await Promise.all(entries.map(async ([filePath, config]) => {
      const activity = reporter.activity(`emit 3rd-party documents into ${filePath}`);
      activity.start();

      try {
        switch (config.format) {
          case 'graphql':
            {
              const printedDocument = definitions.map(def => def.printedAst || '').filter(Boolean).join('\n\n');
              await writeFileContent(filePath, printedDocument);
              break;
            }

          case 'json':
            {
              const document = {
                kind: _graphql.Kind.DOCUMENT,
                definitions: definitions.map(meta => meta.def)
              };
              await writeFileContent(filePath, JSON.stringify(document, null, 2));
              break;
            }
        }
      } catch (e) {
        activity.panic(e);
      } finally {
        activity.end();
      }
    }));
  };
};

exports.makeEmitPluginDocumentService = makeEmitPluginDocumentService;